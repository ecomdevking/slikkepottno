{%- unless template == 'index' -%}
  {%- liquid
    assign justify = section.settings.text_alignment | default: 'start'
  -%}
  <div
    class="section-breadcrumb page-width page-width--{{ section.settings.container }} section--padding"
    style="--section-padding-top: {{ section.settings.padding_top }}px;--section-padding-bottom: {{ section.settings.padding_bottom }}px;"
  >
    <nav
      class="breadcrumbs flex items-center justify-start md:justify-{{ justify }}"
      role="navigation"
      aria-label="breadcrumbs"
    >
      <a href="{{ routes.root_url }}" title="Home" class="reversed-link">{{ 'general.breadcrumbs.home' | t }}</a>
      
      {%- if template contains 'page' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ page.title }}</span>
      
      {%- elsif template contains 'product' -%}
        {%- liquid
          # Finn beste collection
          assign active_collection = null
          assign best_depth = 0
          
          for coll in product.collections
            assign depth = 0
            if coll.metafields.custom.parent_collection.value
              assign depth = depth | plus: 1
            endif
            if coll.metafields.custom.grandparent_collection.value
              assign depth = depth | plus: 1
            endif
            
            if depth > best_depth
              assign active_collection = coll
              assign best_depth = depth
            endif
          endfor
          
          # Fallback til første collection
          if active_collection == null and product.collections.size > 0
            assign active_collection = product.collections | first
          endif
          
          # Bygg hierarki
          assign breadcrumb_collections = ''
          
          if active_collection
            assign grandparent = active_collection.metafields.custom.grandparent_collection.value
            if grandparent
              assign breadcrumb_collections = breadcrumb_collections | append: grandparent.handle | append: ','
            endif
            
            assign parent = active_collection.metafields.custom.parent_collection.value
            if parent
              assign breadcrumb_collections = breadcrumb_collections | append: parent.handle | append: ','
            endif
            
            assign breadcrumb_collections = breadcrumb_collections | append: active_collection.handle
          endif
          
          assign breadcrumb_handles = breadcrumb_collections | split: ','
        -%}
        
        {%- for handle in breadcrumb_handles -%}
          {%- if handle != blank -%}
            {%- assign crumb = collections[handle] -%}
            <span aria-hidden="true" class="breadcrumbs--sep"></span>
            <a href="{{ crumb.url }}" class="reversed-link">{{ crumb.title }}</a>
          {%- endif -%}
        {%- endfor -%}
        
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ product.title }}</span>
      
      {%- elsif template contains 'collection' and collection.handle -%}
        {%- liquid
          assign breadcrumb_collections = ''
          
          assign grandparent = collection.metafields.custom.grandparent_collection.value
          if grandparent
            assign breadcrumb_collections = breadcrumb_collections | append: grandparent.handle | append: ','
          endif
          
          assign parent = collection.metafields.custom.parent_collection.value
          if parent
            assign breadcrumb_collections = breadcrumb_collections | append: parent.handle | append: ','
          endif
          
          assign breadcrumb_handles = breadcrumb_collections | split: ','
        -%}
        
        {%- if collection.handle != 'all' -%}
          {%- for handle in breadcrumb_handles -%}
            {%- if handle != blank -%}
              {%- assign crumb = collections[handle] -%}
              <span aria-hidden="true" class="breadcrumbs--sep"></span>
              <a href="{{ crumb.url }}" class="reversed-link">{{ crumb.title }}</a>
            {%- endif -%}
          {%- endfor -%}
          
          <span aria-hidden="true" class="breadcrumbs--sep"></span>
          <span class="breadcrumbs--last text-subtext">{{ collection.title }}</span>
        {%- else -%}
          <span aria-hidden="true" class="breadcrumbs--sep"></span>
          <span class="breadcrumbs--last text-subtext">{{ 'general.breadcrumbs.collections' | t }}</span>
        {%- endif -%}
      
      {%- elsif template == 'list-collections' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ 'templates.collections.title' | t }}</span>
      
      {%- elsif template == 'blog' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        {%- if current_tags -%}
          <a href="{{ blog.url }}" class="reversed-link">{{ blog.title }}</a>
          <span aria-hidden="true" class="breadcrumbs--sep"></span>
          <span class="breadcrumbs--last text-subtext">{{ current_tags | join: ' + ' }}</span>
        {%- else -%}
          <span class="breadcrumbs--last text-subtext">{{ blog.title }}</span>
        {%- endif -%}
      
      {%- elsif template == 'article' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <a href="{{ blog.url }}" class="reversed-link">{{ blog.title }}</a>
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ article.title }}</span>
      
      {%- elsif template == 'cart' -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ 'general.cart.title' | t }}</span>
      
      {%- else -%}
        <span aria-hidden="true" class="breadcrumbs--sep"></span>
        <span class="breadcrumbs--last text-subtext">{{ page_title }}</span>
      {%- endif -%}
    </nav>
  </div>
{%- endunless -%}

{% schema %}
{
  "name": "t:sections.breadcrumbs.name",
  "disabled_on": {
    "groups": ["header", "footer", "custom.overlay"],
    "templates": ["index"]
  },
  "limit": 1,
  "settings": [
    {
      "type": "select",
      "id": "container",
      "options": [
        {
          "value": "full",
          "label": "t:general.container.options__full.label"
        },
        {
          "value": "fixed",
          "label": "t:general.container.options__fixed.label"
        }
      ],
      "default": "fixed",
      "label": "t:general.container.label"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "t:general.text_alignment.label",
      "options": [
        {
          "value": "start",
          "label": "t:general.text_alignment.options__1.label"
        },
        {
          "value": "center",
          "label": "t:general.text_alignment.options__2.label"
        },
        {
          "value": "end",
          "label": "t:general.text_alignment.options__3.label"
        }
      ],
      "default": "start"
    },
    {
      "type": "paragraph",
      "content": "Breadcrumbs viser kategori-hierarki basert på collection metafields."
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "t:general.padding.top.label",
      "default": 16,
      "min": 0,
      "max": 24,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "t:general.padding.bottom.label",
      "default": 20,
      "min": 0,
      "max": 24,
      "step": 1,
      "unit": "px"
    }
  ],
  "presets": [
    {
      "name": "t:sections.breadcrumbs.name"
    }
  ]
}
{% endschema %}