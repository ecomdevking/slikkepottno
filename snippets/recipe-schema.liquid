{%- comment -%}
Recipe Schema Snippet - Save as snippets/recipe-schema.liquid
Automatically detects and parses ingredients/instructions from blog content
Prioritizes metafields over content parsing
{%- endcomment -%}

{%- comment -%} Check if this article should have recipe schema {%- endcomment -%}
{%- assign is_recipe = false -%}
{%- assign content_lower = article.content | downcase -%}

{%- comment -%} Multilingual detection methods {%- endcomment -%}
{%- if article.tags contains 'recipe' or article.tags contains 'oppskrift' or article.tags contains 'recept' -%}
  {%- assign is_recipe = true -%}
{%- elsif content_lower contains 'ingredients:' or content_lower contains 'ingredienser:' or content_lower contains 'ingrediënten:' -%}
  {%- assign is_recipe = true -%}
{%- elsif content_lower contains 'ingredients</h' or content_lower contains 'ingredienser</h' -%}
  {%- assign is_recipe = true -%}
{%- elsif content_lower contains 'what you need:' or content_lower contains 'det du trenger:' -%}
  {%- assign is_recipe = true -%}
{%- elsif content_lower contains 'instructions:' or content_lower contains 'instruksjoner:' or content_lower contains 'fremgangsmåte:' -%}
  {%- assign is_recipe = true -%}
{%- elsif content_lower contains 'directions:' or content_lower contains 'anvisninger:' -%}
  {%- assign is_recipe = true -%}
{%- elsif content_lower contains 'tilberedning:' or content_lower contains 'slik gjør du:' -%}
  {%- assign is_recipe = true -%}
{%- endif -%}

{%- if is_recipe -%}

{%- comment -%} PRIORITY 1: Check for metafields first {%- endcomment -%}
{%- assign prep_time = article.metafields.custom.prep_time.value | default: '' -%}
{%- assign cook_time = article.metafields.custom.cook_time.value | default: '' -%}
{%- assign total_time = article.metafields.custom.total_time.value | default: '' -%}
{%- assign recipe_yield = article.metafields.custom.recipe_yield.value | default: '' -%}
{%- assign recipe_category = article.metafields.custom.recipe_category.value | default: 'Recipe' -%}
{%- assign recipe_cuisine = article.metafields.custom.recipe_cuisine.value | default: '' -%}

{%- comment -%} FALLBACK: Dynamic time detection from content if metafields don't exist {%- endcomment -%}
{%- if prep_time == '' or cook_time == '' or total_time == '' -%}

  {%- comment -%} Extract prep time from content {%- endcomment -%}
  {%- assign should_check_prep = false -%}
  {%- if prep_time == '' -%}
    {%- if content_lower contains 'forberedelsestid' or content_lower contains 'prep time' or content_lower contains 'tilberedningstid' -%}
      {%- assign should_check_prep = true -%}
    {%- endif -%}
  {%- endif -%}
  
  {%- if should_check_prep -%}
    {%- assign prep_patterns = 'forberedelsestid,prep time,tilberedningstid' | split: ',' -%}
    {%- for pattern in prep_patterns -%}
      {%- if content_lower contains pattern -%}
        {%- assign prep_section = content_lower | split: pattern | last | split: 'minutter' | first | split: 'timer' | first -%}
        {%- assign prep_numbers = prep_section | replace: ':', '' | replace: ' ', '' | split: '' -%}
        {%- assign found_number = '' -%}
        {%- for char in prep_numbers limit: 10 -%}
          {%- if char >= '0' and char <= '9' -%}
            {%- assign found_number = found_number | append: char -%}
          {%- elsif found_number != '' -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
        {%- if found_number != '' and found_number != '0' -%}
          {%- assign prep_time = 'PT' | append: found_number | append: 'M' -%}
          {%- break -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  {%- comment -%} Extract cooking time from content - more comprehensive patterns {%- endcomment -%}
  {%- if cook_time == '' -%}
    {%- assign time_patterns = '1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,35,40,45,50,55,60,90,120' | split: ',' -%}
    {%- for time_num in time_patterns -%}
      {%- assign time_pattern_min = time_num | append: ' minutter' -%}
      {%- assign time_pattern_min_short = time_num | append: ' min' -%}
      {%- assign time_pattern_timer = time_num | append: ' timer' -%}
      
      {%- assign has_time_pattern = false -%}
      {%- if content_lower contains time_pattern_min or content_lower contains time_pattern_min_short -%}
        {%- assign has_time_pattern = true -%}
      {%- endif -%}
      
      {%- if has_time_pattern -%}
        {%- assign has_cooking_context = false -%}
        {%- if content_lower contains 'steketid' or content_lower contains 'koketid' or content_lower contains 'baketid' -%}
          {%- assign has_cooking_context = true -%}
        {%- elsif content_lower contains 'cooking time' or content_lower contains 'baking time' -%}
          {%- assign has_cooking_context = true -%}
        {%- endif -%}
        
        {%- if has_cooking_context -%}
          {%- assign cook_time = 'PT' | append: time_num | append: 'M' -%}
          {%- break -%}
        {%- elsif cook_time == '' -%}
          {%- comment -%} If no specific cooking context, assume it's cooking time {%- endcomment -%}
          {%- assign cook_time = 'PT' | append: time_num | append: 'M' -%}
        {%- endif -%}
      {%- elsif content_lower contains time_pattern_timer -%}
        {%- assign time_in_minutes = time_num | times: 60 -%}
        {%- assign cook_time = 'PT' | append: time_in_minutes | append: 'M' -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  {%- comment -%} Calculate total time if not in metafields {%- endcomment -%}
  {%- if total_time == '' -%}
    {%- if prep_time != '' and cook_time != '' -%}
      {%- assign prep_minutes = prep_time | replace: 'PT', '' | replace: 'M', '' | plus: 0 -%}
      {%- assign cook_minutes = cook_time | replace: 'PT', '' | replace: 'M', '' | plus: 0 -%}
      {%- assign total_minutes = prep_minutes | plus: cook_minutes -%}
      {%- if total_minutes >= 60 -%}
        {%- assign hours = total_minutes | divided_by: 60 -%}
        {%- assign remaining_minutes = total_minutes | modulo: 60 -%}
        {%- if remaining_minutes == 0 -%}
          {%- assign total_time = 'PT' | append: hours | append: 'H' -%}
        {%- else -%}
          {%- assign total_time = 'PT' | append: hours | append: 'H' | append: remaining_minutes | append: 'M' -%}
        {%- endif -%}
      {%- else -%}
        {%- assign total_time = 'PT' | append: total_minutes | append: 'M' -%}
      {%- endif -%}
    {%- elsif cook_time != '' -%}
      {%- assign total_time = cook_time -%}
    {%- elsif prep_time != '' -%}
      {%- assign total_time = prep_time -%}
    {%- endif -%}
  {%- endif -%}

{%- endif -%}

{%- comment -%} Set default cuisine if not in metafields {%- endcomment -%}
{%- if recipe_cuisine == '' -%}
  {%- if article.tags contains 'norsk' or article.tags contains 'norwegian' -%}
    {%- assign recipe_cuisine = 'Norwegian' -%}
  {%- else -%}
    {%- assign recipe_cuisine = 'Scandinavian' -%}
  {%- endif -%}
{%- endif -%}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Recipe",
  "name": {{ article.title | json }},
  "description": {{ article.excerpt_or_content | strip_html | truncatewords: 25 | json }},
  "datePublished": "{{ article.published_at | date: '%Y-%m-%d' }}",
  "dateModified": "{{ article.updated_at | date: '%Y-%m-%d' }}",
  {%- comment -%} Add author name properly {%- endcomment -%}
  "author": {
    "@type": "Person",
    "name": "{% if article.user.first_name != blank %}{{ article.user.first_name }} {{ article.user.last_name }}{% else %}{{ shop.name }}{% endif %}"
  },
  "publisher": {
    "@type": "Organization",
    "name": {{ shop.name | json }}
  }
  {%- comment -%} Add keywords from article tags {%- endcomment -%}
  {%- if article.tags.size > 0 -%}
  ,"keywords": "{{ article.tags | join: ', ' }}"
  {%- endif -%}
  {%- comment -%} Add recipe cuisine {%- endcomment -%}
  ,"recipeCuisine": {{ recipe_cuisine | json }}
  {%- if article.image -%}
  ,"image": [
    {{ article.image | image_url: width: 1200, height: 675 | prepend: 'https:' | json }},
    {{ article.image | image_url: width: 1200, height: 1200 | prepend: 'https:' | json }},
    {{ article.image | image_url: width: 1200, height: 900 | prepend: 'https:' | json }}
  ]
  {%- endif -%}
  
  {%- comment -%} Add detected/metafield times {%- endcomment -%}
  {%- if prep_time != '' -%}
  ,"prepTime": {{ prep_time | json }}
  {%- endif -%}
  {%- if cook_time != '' -%}
  ,"cookTime": {{ cook_time | json }}
  {%- endif -%}
  {%- if total_time != '' -%}
  ,"totalTime": {{ total_time | json }}
  {%- endif -%}
  
  {%- comment -%} PRIORITY 1: Check for ingredients metafield, FALLBACK: Parse from content {%- endcomment -%}
  {%- if article.metafields.custom.ingredients.value -%}
    {%- assign ingredients = article.metafields.custom.ingredients.value -%}
    {%- if ingredients.categories.size > 0 -%}
  ,"recipeIngredient": [
      {%- assign ingredient_count = 0 -%}
      {%- for category in ingredients.categories -%}
        {%- for item in category.items -%}
          {%- if item.name and item.name != '' -%}
            {%- assign ingredient_string = item.name -%}
            {%- if item.quantity and item.quantity != '' -%}
              {%- assign ingredient_string = item.quantity | append: ' ' | append: ingredient_string -%}
            {%- endif -%}
            {%- if item.unit and item.unit != '' -%}
              {%- assign ingredient_string = ingredient_string | append: ' ' | append: item.unit -%}
            {%- endif -%}
            {%- if ingredient_count > 0 -%},{%- endif -%}
            {{ ingredient_string | strip | json }}
            {%- assign ingredient_count = ingredient_count | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endfor -%}
    ]
    {%- endif -%}
  {%- else -%}
    {%- assign has_ingredients = false -%}
    {%- if content_lower contains 'ingredienser' and content_lower contains '<ul>' -%}
      {%- assign has_ingredients = true -%}
    {%- endif -%}
    
    {%- if has_ingredients -%}
      {%- comment -%} FALLBACK: Parse ingredients from content {%- endcomment -%}
      {%- assign content_parts = article.content | split: 'Ingredienser' -%}
      {%- if content_parts.size > 1 -%}
        {%- assign ingredients_section = content_parts[1] | split: 'Du trenger' | first | split: 'Fremgangsmåte' | first -%}
        {%- if ingredients_section contains '<li' -%}
          {%- assign li_items = ingredients_section | split: '<li' -%}
  ,"recipeIngredient": [
            {%- assign ingredient_count = 0 -%}
            {%- for item in li_items -%}
              {%- if item contains '</li>' and forloop.index > 1 -%}
                {%- assign clean_item = item | split: '</li>' | first -%}
                {%- comment -%} Remove HTML attributes BEFORE strip_html {%- endcomment -%}
                {%- assign clean_item = clean_item | replace: 'style="font-weight: 400;" aria-level="1">', '' -%}
                {%- assign clean_item = clean_item | replace: 'style="font-weight: 400;" aria-level="1"', '' -%}
                {%- assign clean_item = clean_item | replace: '&gt;', '' -%}
                {%- assign clean_item = clean_item | strip_html | strip -%}
                {%- comment -%} Remove leading > character if it survived {%- endcomment -%}
                {%- if clean_item.size > 0 -%}
                  {%- assign first_char = clean_item | slice: 0 -%}
                  {%- if first_char == '>' -%}
                    {%- assign clean_item = clean_item | slice: 1, clean_item.size -%}
                    {%- assign clean_item = clean_item | strip -%}
                  {%- endif -%}
                {%- endif -%}
                {%- if clean_item != '' and clean_item.size > 2 -%}
                  {%- if ingredient_count > 0 -%},{%- endif -%}
                  {{ clean_item | json }}
                  {%- assign ingredient_count = ingredient_count | plus: 1 -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          ]
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
  
  {%- comment -%} PRIORITY 1: Check for equipment metafield, FALLBACK: Parse from content {%- endcomment -%}
  {%- assign has_tools = false -%}
  {%- if article.metafields.custom.equipment.value -%}
    {%- assign equipment = article.metafields.custom.equipment.value -%}
    {%- if equipment.categories.size > 0 -%}
      {%- assign has_tools = true -%}
  ,"tool": [
      {%- assign tool_count = 0 -%}
      {%- for category in equipment.categories -%}
        {%- for item in category.items -%}
          {%- if item.name and item.name != '' -%}
            {%- if tool_count > 0 -%},{%- endif -%}
            {
              "@type": "HowToTool",
              "name": {{ item.name | json }}
            }
            {%- assign tool_count = tool_count | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endfor -%}
    ]
    {%- endif -%}
  {%- else -%}
    {%- assign has_equipment = false -%}
    {%- if content_lower contains 'du trenger' and content_lower contains '<ul>' -%}
      {%- assign has_equipment = true -%}
    {%- endif -%}
    
    {%- if has_equipment -%}
      {%- comment -%} FALLBACK: Parse equipment from content {%- endcomment -%}
      {%- assign equipment_parts = article.content | split: 'Du trenger' -%}
      {%- if equipment_parts.size > 1 -%}
        {%- assign equipment_section = equipment_parts[1] | split: 'Fremgangsmåte' | first | split: '</div>' | first -%}
        {%- if equipment_section contains '<li' -%}
          {%- assign eq_items = equipment_section | split: '<li' -%}
          {%- assign has_tools = true -%}
  ,"tool": [
            {%- assign tool_count = 0 -%}
            {%- for item in eq_items -%}
              {%- if item contains '</li>' and forloop.index > 1 -%}
                {%- assign clean_item = item | split: '</li>' | first -%}
                {%- comment -%} Remove HTML attributes BEFORE strip_html {%- endcomment -%}
                {%- assign clean_item = clean_item | replace: 'style="font-weight: 400;" aria-level="1">', '' -%}
                {%- assign clean_item = clean_item | replace: 'style="font-weight: 400;" aria-level="1"', '' -%}
                {%- assign clean_item = clean_item | replace: '&gt;', '' -%}
                {%- assign clean_item = clean_item | strip_html | strip -%}
                {%- comment -%} Remove leading > character if it survived {%- endcomment -%}
                {%- if clean_item.size > 0 -%}
                  {%- assign first_char = clean_item | slice: 0 -%}
                  {%- if first_char == '>' -%}
                    {%- assign clean_item = clean_item | slice: 1, clean_item.size -%}
                    {%- assign clean_item = clean_item | strip -%}
                  {%- endif -%}
                {%- endif -%}
                {%- if clean_item != '' and clean_item.size > 2 -%}
                  {%- if tool_count > 0 -%},{%- endif -%}
                  {
                    "@type": "HowToTool",
                    "name": {{ clean_item | json }}
                  }
                  {%- assign tool_count = tool_count | plus: 1 -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          ]
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
  
  {%- comment -%} Parse instructions from "Fremgangsmåte" section {%- endcomment -%}
  {%- if content_lower contains 'fremgangsmåte' -%}
    {%- assign inst_start = article.content | downcase | split: '<h2>fremgangsmåte</h2>' -%}
    {%- if inst_start.size == 1 -%}
      {%- assign inst_start = article.content | downcase | split: '<h3>fremgangsmåte</h3>' -%}
    {%- endif -%}
    
    {%- if inst_start.size > 1 -%}
  ,"recipeInstructions": [
        {
          "@type": "HowToStep",
          "text": "Se fullstendig fremgangsmåte i blogginlegget"
        }
      ]
    {%- endif -%}
  {%- endif -%}
  
  {%- comment -%} Parse servings - metafields first, then content {%- endcomment -%}
  {%- if recipe_yield == '' and content_lower contains 'oppskriften gir' -%}
    {%- assign serves_match = content_lower | split: 'oppskriften gir' | last | split: 'kjeks' | first -%}
    {%- assign serves_numbers = serves_match | replace: 'ca', '' | replace: ' ', '' | split: '' -%}
    {%- assign serving_count = '' -%}
    {%- for char in serves_numbers limit: 5 -%}
      {%- if char >= '0' and char <= '9' -%}
        {%- assign serving_count = serving_count | append: char -%}
      {%- endif -%}
    {%- endfor -%}
    {%- if serving_count != '' -%}
      {%- assign recipe_yield = serving_count | append: ' kjeks' -%}
    {%- endif -%}
  {%- endif -%}
  
  {%- comment -%} Final required fields {%- endcomment -%}
  {%- if recipe_yield != '' -%}
  ,"recipeYield": {{ recipe_yield | json }}
  {%- endif -%}
  ,"recipeCategory": {{ recipe_category | json }}
  ,"url": "{{ shop.url }}{{ article.url }}"
}
</script>
{%- endif -%}